'use client';

import { useEffect, useMemo, useState } from 'react';
import { useRouter } from 'next/navigation';
import { supabase } from '@/lib/supabase';

const HOME_ROUTE = '/rosterly';

type WeekdayKey = 'sun' | 'mon' | 'tue' | 'wed' | 'thu';
type WeekendKey = 'fri' | 'sat';
type DayKey = WeekdayKey | WeekendKey;

type WeekdayChoice = 'פתוח' | 'בוקר' | 'ערב' | 'לא זמין';
type WeekendChoice = 'פתוח' | 'שישי' | 'מוצ״ש' | 'לא זמין';

const WEEKDAYS: { key: WeekdayKey; label: string }[] = [
  { key: 'sun', label: 'ראשון' },
  { key: 'mon', label: 'שני' },
  { key: 'tue', label: 'שלישי' },
  { key: 'wed', label: 'רביעי' },
  { key: 'thu', label: 'חמישי' },
];

const CHOICES_WEEKDAY: WeekdayChoice[] = ['פתוח', 'בוקר', 'ערב', 'לא זמין'];
const CHOICES_WEEKEND: WeekendChoice[] = ['פתוח', 'שישי', 'מוצ״ש', 'לא זמין'];

// Get Sunday of current week as YYYY-MM-DD
function getCurrentWeekStartSunday(): string {
  const today = new Date();
  const day = today.getDay(); // 0 Sun, 1 Mon, ...
  const diff = today.getDate() - day; // go back to Sunday
  const sunday = new Date(today);
  sunday.setDate(diff);
  sunday.setHours(0, 0, 0, 0);
  return sunday.toISOString().slice(0, 10);
}

export default function SubmitPage() {
  const router = useRouter();
  const [email, setEmail] = useState<string | null>(null);
  const [employeeId, setEmployeeId] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [status, setStatus] = useState('');
  const [globalNote, setGlobalNote] = useState('');

  const [weekdayChoices, setWeekdayChoices] = useState<
    Record<WeekdayKey, WeekdayChoice>
  >({
    sun: 'פתוח',
    mon: 'פתוח',
    tue: 'פתוח',
    wed: 'פתוח',
    thu: 'פתוח',
  });

  const [weekendChoice, setWeekendChoice] = useState<WeekendChoice>('לא זמין');

  const weekStart = useMemo(() => getCurrentWeekStartSunday(), []);

  // Load user + existing submission
  useEffect(() => {
    const init = async () => {
      try {
        const { data, error } = await supabase.auth.getUser();
        if (error || !data.user) {
          router.replace('/auth');
          return;
        }

        setEmail(data.user.email ?? null);

        // find linked employee
        const { data: emp, error: empErr } = await supabase
          .from('employees')
          .select('id')
          .eq('user_uid', data.user.id)
          .single();

        if (empErr || !emp?.id) {
          setStatus(
            '❌ לא נמצא עובד מקושר למשתמש. פנה/י למנהל שיחבר אותך במערכת.'
          );
          setLoading(false);
          return;
        }

        setEmployeeId(emp.id as string);

        // try to load existing submission for this week
        const { data: submission, error: subErr } = await supabase
          .from('submissions')
          .select('id')
          .eq('employee_id', emp.id)
          .eq('week_start', weekStart)
          .single();

        if (!subErr && submission?.id) {
          const { data: days, error: daysErr } = await supabase
            .from('submission_days')
            .select('day, available, note')
            .eq('submission_id', submission.id);

          if (!daysErr && days && days.length > 0) {
            const nextWeekdays: Record<WeekdayKey, WeekdayChoice> = {
              sun: 'לא זמין',
              mon: 'לא זמין',
              tue: 'לא זמין',
              wed: 'לא זמין',
              thu: 'לא זמין',
            };

            let friAvailable = false;
            let satAvailable = false;

            days.forEach((d: any) => {
              const key = d.day as DayKey;
              const available = !!d.available;
              if (
                key === 'sun' ||
                key === 'mon' ||
                key === 'tue' ||
                key === 'wed' ||
                key === 'thu'
              ) {
                nextWeekdays[key] = available ? 'פתוח' : 'לא זמין';
              } else if (key === 'fri') {
                friAvailable = available;
              } else if (key === 'sat') {
                satAvailable = available;
              }
            });

            let nextWeekend: WeekendChoice = 'לא זמין';
            if (friAvailable && satAvailable) nextWeekend = 'פתוח';
            else if (friAvailable && !satAvailable) nextWeekend = 'שישי';
            else if (!friAvailable && satAvailable) nextWeekend = 'מוצ״ש';

            setWeekdayChoices(nextWeekdays);
            setWeekendChoice(nextWeekend);

            const firstNote = days.find((d: any) => d.note)?.note;
            if (firstNote) setGlobalNote(firstNote);
            setStatus('✅ נטען טופס קיים – אפשר לערוך ולשמור מחדש.');
          }
        }
      } catch {
        setStatus('❌ שגיאה בטעינת העמוד.');
      } finally {
        setLoading(false);
      }
    };

    void init();
  }, [router, weekStart]);

  function setWeekdayChoice(day: WeekdayKey, value: WeekdayChoice) {
    setWeekdayChoices((prev) => ({ ...prev, [day]: value }));
  }

  async function handleSubmit() {
    if (!employeeId) {
      setStatus('❌ לא נמצא עובד במערכת.');
      return;
    }

    setSaving(true);
    setStatus('שומר...');

    try {
      // upsert submission row
      const { data: submission, error: subErr } = await supabase
        .from('submissions')
        .upsert(
          { week_start: weekStart, employee_id: employeeId },
          { onConflict: 'week_start,employee_id' }
        )
        .select('id')
        .single();

      if (subErr || !submission?.id) {
        setStatus('❌ כשל בשמירת הבקשה: ' + (subErr?.message ?? ''));
        setSaving(false);
        return;
      }

      const submissionId = submission.id as string;

      // clear previous days
      await supabase
        .from('submission_days')
        .delete()
        .eq('submission_id', submissionId);

      // weekday rows
      const weekdayRows = WEEKDAYS.map((d) => {
        const choice = weekdayChoices[d.key];
        const available = choice !== 'לא זמין';
        return {
          submission_id: submissionId,
          day: d.key,
          available,
          start_time: null,
          end_time: null,
          note: globalNote || null,
        };
      });

      // weekend rows from combined choice (Fri + Sat)
      let friAvailable = false;
      let satAvailable = false;
      switch (weekendChoice) {
        case 'פתוח':
          friAvailable = true;
          satAvailable = true;
          break;
        case 'שישי':
          friAvailable = true;
          satAvailable = false;
          break;
        case 'מוצ״ש':
          friAvailable = false;
          satAvailable = true;
          break;
        case 'לא זמין':
        default:
          friAvailable = false;
          satAvailable = false;
      }

      const weekendRows = [
        {
          submission_id: submissionId,
          day: 'fri' as WeekendKey,
          available: friAvailable,
          start_time: null,
          end_time: null,
          note: globalNote || null,
        },
        {
          submission_id: submissionId,
          day: 'sat' as WeekendKey,
          available: satAvailable,
          start_time: null,
          end_time: null,
          note: globalNote || null,
        },
      ];

      const rows = [...weekdayRows, ...weekendRows];

      const { error: insErr } = await supabase
        .from('submission_days')
        .insert(rows);

      if (insErr) {
        setStatus('❌ כשל בשמירת הימים: ' + insErr.message);
      } else {
        setStatus('✅ המשמרות נשמרו בהצלחה!');
      }
    } catch {
      setStatus('❌ שגיאת מערכת בעת שמירה.');
    } finally {
      setSaving(false);
    }
  }

  const handleLoginClick = () => {
    router.push('/rosterly/login');
  };

  const goHome = () => router.push(HOME_ROUTE);

  if (loading) {
    return (
      <main dir="rtl" className="page">
        <div className="page-inner">
          <div className="center-card">טוען את טופס המשמרות...</div>
        </div>
        <style jsx>{`
          .page {
            min-height: 100vh;
            background: #f5f3ef;
            display: flex;
            justify-content: center;
          }
          .page-inner {
            width: 100%;
            max-width: 1200px;
            padding: 16px 32px 40px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
              sans-serif;
          }
          .center-card {
            margin: 140px auto 0;
            max-width: 460px;
            padding: 20px 24px;
            border-radius: 18px;
            background: #f0e7d8;
            text-align: center;
            font-size: 14px;
            color: #4f553d;
          }
        `}</style>
      </main>
    );
  }

  return (
    <main dir="rtl" className="page">
      <div className="page-inner">
        {/* Top nav – same structure / look as main Rosterly page */}
        <nav className="top-nav">
          <div
            className="nav-logo"
            style={{ cursor: 'pointer' }}
            onClick={goHome}
          >
            Rosterly
          </div>
          <div className="nav-links">
            <button
              className="login-btn"
              type="button"
              onClick={handleLoginClick}
            >
              {email ? 'מחובר/ת' : 'להתחבר'}
            </button>
            <a href="/rosterly/team?lang=he">צוות</a>
            <a href="/rosterly/forum?lang=he">פורום</a>
            <a href="/rosterly/tutorials?lang=he">מדריכים</a>
          </div>
        </nav>

        {/* Center content */}
        <div className="content">
          {/* Logo + title */}
          <section className="hero">
            <div className="logo-card">
              <img
                src="/logo-rosterly.svg"
                alt="Rosterly"
                className="logo-img"
              />
            </div>
            <h1 className="hero-title">הגשת משמרות לצוות החנות</h1>
            <p className="hero-subtitle">
              סימון זמינות שבועית בצורה מסודרת, נקייה ובלי כאבי ראש.
            </p>
          </section>

          {/* Form card */}
          <section className="card card-form">
            <div className="card-header">
              <div className="card-title-row">
                <h2 className="card-title">טופס זמינות לשבוע הקרוב</h2>
                <span className="pill small">שבוע שמתחיל ב־ {weekStart}</span>
              </div>
              <p className="card-description">
                לכל יום בחר/י אם את/ה פתוח/ה לכל משמרת, מעדיפ/ה בוקר, ערב או לא
                זמינ/ה בכלל.
              </p>
            </div>

            {/* Weekday rows */}
            <div className="days-list">
              {WEEKDAYS.map((d) => {
                const choice = weekdayChoices[d.key];

                return (
                  <div
                    key={d.key}
                    className={
                      'day-row' +
                      (choice === 'לא זמין'
                        ? ' day-row--no'
                        : ' day-row--yes')
                    }
                  >
                    <div className="day-main">
                      <span className="day-label">{d.label}</span>
                      <span className="pill pill-tag">אמצע שבוע</span>
                    </div>
                    <div className="day-side">
                      <div className="choice-group">
                        {CHOICES_WEEKDAY.map((opt) => (
                          <button
                            key={opt}
                            type="button"
                            className={
                              'choice-pill' +
                              (choice === opt ? ' choice-pill--active' : '')
                            }
                            onClick={() => setWeekdayChoice(d.key, opt)}
                          >
                            {opt}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                );
              })}

              {/* Weekend combined row */}
              <div
                className={
                  'day-row' +
                  (weekendChoice === 'לא זמין'
                    ? ' day-row--no'
                    : ' day-row--yes')
                }
              >
                <div className="day-main">
                  <span className="day-label">סופ״ש</span>
                  <span className="pill pill-tag pill-tag--weekend">סופ״ש</span>
                </div>
                <div className="day-side">
                  <div className="choice-group">
                    <span className="we-label">סופ&quot;ש:</span>
                    {CHOICES_WEEKEND.map((opt) => (
                      <button
                        key={opt}
                        type="button"
                        className={
                          'choice-pill' +
                          (weekendChoice === opt
                            ? ' choice-pill--active'
                            : '')
                        }
                        onClick={() => setWeekendChoice(opt)}
                      >
                        {opt}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {/* Note */}
            <div className="field">
              <label className="field-label">הערה כללית למנהל</label>
              <p className="field-help">
                למשל: שיעורים, ימים מועדפים, מגבלות שעות ועוד.
              </p>
              <textarea
                className="field-textarea"
                rows={3}
                value={globalNote}
                onChange={(e) => setGlobalNote(e.target.value)}
              />
            </div>

            {/* Actions */}
            <div className="actions">
              <button
                type="button"
                onClick={handleSubmit}
                disabled={saving}
                className="primary-button"
              >
                {saving ? 'שומר...' : 'שליחת ההגשה'}
              </button>
              {status && <p className="status-text">{status}</p>}
              <p className="status-help">
                ניתן לערוך את ההגשה עד סגירת המועד ביום ג׳ בשעה 12:00.
              </p>
            </div>
          </section>

          <footer className="footer">
            <a href="#" className="footer-link">
              Privacy
            </a>
            <span className="dot">•</span>
            <a href="#" className="footer-link">
              Terms
            </a>
            <span className="dot">•</span>
            <span className="footer-link">© Rosterly 2025</span>
          </footer>
        </div>
      </div>

      <style jsx>{`
        .page {
          min-height: 100vh;
          background: #f5f3ef;
          display: flex;
          justify-content: center;
        }

        .page-inner {
          width: 100%;
          max-width: 1440px;
          padding: 12px 32px 32px;
          font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
            sans-serif;
          color: #333;
        }

        /* NAV – copied from main Rosterly page */
        .top-nav {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 1.25rem 2.5rem 0;
          font-size: 0.85rem;
          direction: ltr;
        }

        .nav-logo {
          font-weight: 600;
          color: #4f553d;
        }

        .nav-links {
          display: flex;
          align-items: center;
          gap: 1.5rem;
        }

        .nav-links a {
          color: #6d6d6d;
          text-decoration: none;
        }

        .nav-links .login-btn {
          border-radius: 999px;
          padding: 0.35rem 1.5rem;
          border: none;
          background: #4f553d;
          color: #f5f3ef;
          cursor: pointer;
          font-size: 0.8rem;
        }

        /* PAGE CONTENT */

        .content {
          max-width: 720px;
          margin: 40px auto 0;
          text-align: center;
        }

        .hero {
          margin-bottom: 28px;
        }

        .logo-card {
          width: 110px;
          height: 110px;
          margin: 0 auto 18px;
          border-radius: 26px;
          background: #f0e7d8;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.03);
        }

        .logo-img {
          max-width: 70px;
          height: auto;
        }

        .hero-title {
          font-size: 20px;
          margin-bottom: 6px;
          color: #3a3e2d;
          font-weight: 600;
        }

        .hero-subtitle {
          font-size: 13px;
          color: #777;
          margin: 0;
        }

        .card {
          background: #efe6d8;
          border-radius: 18px;
          padding: 18px 22px 20px;
          text-align: right;
          box-shadow: 0 14px 35px rgba(0, 0, 0, 0.03);
        }

        .card-form {
          margin-bottom: 32px;
        }

        .card-header {
          margin-bottom: 16px;
        }

        .card-title-row {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 8px;
          margin-bottom: 4px;
        }

        .card-title {
          font-size: 15px;
          margin: 0;
          color: #3a3e2d;
        }

        .card-description {
          margin: 0;
          font-size: 12px;
          color: #6b6458;
        }

        .pill {
          display: inline-flex;
          align-items: center;
          border-radius: 999px;
          padding: 3px 10px;
          font-size: 11px;
          background: #e0d6c3;
          color: #4f553d;
        }

        .pill.small {
          font-size: 10px;
          padding-inline: 8px;
        }

        .pill-tag {
          background: #e5ddcc;
          font-size: 10px;
          padding: 2px 8px;
        }

        .pill-tag--weekend {
          background: #e9d8c9;
        }

        .days-list {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-bottom: 16px;
        }

        .day-row {
          border-radius: 14px;
          padding: 9px 12px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 10px;
          background: #f4eee2;
          border: 1px solid #e3dacb;
          transition: background 0.15s ease, box-shadow 0.15s ease;
        }

        .day-row--yes {
          background: #f1f6ea;
          border-color: #d3e2bf;
        }

        .day-row--no {
          background: #f4eee2;
          border-color: #e3dacb;
        }

        .day-row:hover {
          box-shadow: 0 8px 18px rgba(0, 0, 0, 0.04);
        }

        .day-main {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .day-label {
          font-size: 13px;
          color: #3a3e2d;
          font-weight: 500;
        }

        .day-side {
          display: flex;
          flex-direction: column;
          align-items: flex-end;
          gap: 4px;
          width: 65%;
        }

        .choice-group {
          display: flex;
          gap: 4px;
          justify-content: flex-end;
          align-items: center;
          flex-wrap: wrap;
        }

        .we-label {
          font-size: 11px;
          color: #6f6456;
          margin-left: 4px;
        }

        .choice-pill {
          border-radius: 999px;
          border: 1px solid #d3ccbf;
          background: #f7f2e9;
          padding: 3px 7px;
          font-size: 11px;
          color: #746b5e;
          cursor: pointer;
          min-width: 52px;
        }

        .choice-pill--active {
          background: #4f553d;
          color: #f5f3ef;
          border-color: #4f553d;
        }

        .field {
          margin-bottom: 16px;
        }

        .field-label {
          font-size: 12px;
          font-weight: 500;
          color: #3a3e2d;
          display: block;
          margin-bottom: 2px;
        }

        .field-help {
          font-size: 11px;
          color: #7c7364;
          margin: 0 0 6px;
        }

        .field-textarea {
          width: 100%;
          border-radius: 12px;
          border: 1px solid #d9cfbf;
          padding: 8px 10px;
          font-size: 12px;
          resize: vertical;
          background: #f7f2e9;
          color: #3a3e2d;
          outline: none;
        }

        .field-textarea:focus {
          border-color: #b4b08f;
        }

        .actions {
          text-align: left;
        }

        .primary-button {
          border: none;
          outline: none;
          padding: 8px 22px;
          border-radius: 999px;
          background: #4f553d;
          color: #f5f3ef;
          font-size: 13px;
          font-weight: 500;
          cursor: pointer;
          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
          transition: background 0.12s ease, transform 0.08s ease,
            box-shadow 0.12s ease;
        }

        .primary-button:hover:not(:disabled) {
          background: #444933;
          transform: translateY(-1px);
          box-shadow: 0 10px 22px rgba(0, 0, 0, 0.18);
        }

        .primary-button:active:not(:disabled) {
          transform: translateY(0);
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.14);
        }

        .primary-button:disabled {
          opacity: 0.7;
          cursor: default;
          box-shadow: none;
        }

        .status-text {
          margin: 8px 0 0;
          font-size: 11px;
          color: #4b4336;
        }

        .status-help {
          margin: 4px 0 0;
          font-size: 10px;
          color: #8b8172;
        }

        .footer {
          margin-top: 60px;
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 6px;
          font-size: 10px;
          color: #aaa08e;
        }

        .footer-link {
          text-decoration: none;
          color: #b2a894;
        }

        .dot {
          color: #c8bfad;
        }

        @media (max-width: 768px) {
          .page-inner {
            padding-inline: 16px;
          }

          .content {
            margin-top: 26px;
          }

          .card-title-row {
            flex-direction: column;
            align-items: flex-start;
          }

          .day-side {
            width: 100%;
          }

          .choice-group {
            justify-content: space-between;
          }

          .actions {
            text-align: right;
          }
        }
      `}</style>
    </main>
  );
}
