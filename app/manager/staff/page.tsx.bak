// app/manager/staff/page.tsx
'use client';

import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase';

type AccessLevel = 'ADMIN'|'MANAGER'|'BASIC_PLUS'|'BASIC2'|'BASIC1'|'BASIC'|null;

type EmployeeRow = {
  id: string;
  full_name: string | null;
  id_number: string;
  phone: string | null;
  role: string | null;
  active: boolean | null;
  global_worker: boolean | null;
  hired_date: string | null; // YYYY-MM-DD
};

// Access (RLS) vs. Display roles
const ROLE_CODES = [
  { code: 'store_manager',        label: 'Store Manager (ADMIN)' },
  { code: 'assistant_op_manager', label: 'Assistant OP Manager (ADMIN)' },
  { code: 'assistant_manager',    label: 'Assistant Manager (MANAGER)' },
  { code: 'head_cashier',         label: 'Head Cashier (BASIC+)' },
  { code: 'key_holder',           label: 'Key Holder (BASIC+)' },
  { code: 'warehouse_keeper',     label: 'Warehouse keeper (BASIC)' },
  { code: 'cashier',              label: 'Cashier (BASIC1)' },
  { code: 'seller',               label: 'Seller (BASIC2)' },
];

const ROLE_DISPLAY = [
  'Store Manager',
  'Assistant OP Manager',
  'Assistant Manager',
  'Head Cashier',
  'Key Holder',
  'Warehouse keeper (מחסנאי)',
  'Cashier',
  'Seller',
];

export default function StaffPage() {
  // Gate: only ADMIN/MANAGER may access
  const [access, setAccess] = useState<AccessLevel>(null);
  const [loadingAccess, setLoadingAccess] = useState(true);

  // List state
  const [rows, setRows] = useState<EmployeeRow[] | null>(null);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState('');

  // Search
  const [q, setQ] = useState('');
  const dq = useDebounce(q, 350);

  // Modal state
  const [open, setOpen] = useState(false);
  const [saving, setSaving] = useState(false);
  const [formErr, setFormErr] = useState('');

  const [form, setForm] = useState({
    full_name: '',
    id_number: '',
    phone: '',
    role: 'Assistant Manager',        // employees.role (display)
    role_code: 'assistant_manager',   // user_roles.role_code (access)
    hired_date: todayISO(),
    active: true,
    global_worker: false,
  });

  // Load session + access (why: block DB calls for non-privileged users)
  useEffect(() => {
    let off = false;
    (async () => {
      try {
        const { data: u } = await supabase.auth.getUser();
        if (!u?.user) { if (!off) { setAccess(null); setLoadingAccess(false); } return; }
        const { data: lvl } = await supabase.rpc('auth_access_level', { p_uid: u.user.id });
        if (!off) { setAccess((lvl as AccessLevel) ?? null); setLoadingAccess(false); }
      } catch {
        if (!off) { setAccess(null); setLoadingAccess(false); }
      }
    })();
    return () => { off = true; };
  }, []);

  // Load employees
  useEffect(() => {
    let off = false;
    (async () => {
      if (loadingAccess) return;
      if (!(access === 'ADMIN' || access === 'MANAGER')) { setLoading(false); return; }

      setLoading(true); setErr('');
      try {
        const base = supabase
          .from('employees')
          .select('id, full_name, id_number, phone, role, active, global_worker, hired_date')
          .order('full_name', { ascending: true });

        const query = dq ? base.ilike('full_name', `%${dq}%`) : base;
        const { data, error } = await query;
        if (error) throw new Error(error.message);
        if (!off) setRows((data ?? []) as EmployeeRow[]);
      } catch (e: any) {
        if (!off) setErr(e?.message ?? 'שגיאה בטעינת עובדים');
      } finally {
        if (!off) setLoading(false);
      }
    })();
    return () => { off = true; };
  }, [access, loadingAccess, dq]);

  // Create employee + auth (ADMIN-only endpoint)
  async function handleCreate(e: React.FormEvent) {
    e.preventDefault();
    setFormErr('');

    const idn   = form.id_number.trim();
    const name  = form.full_name.trim();
    const phone = form.phone.trim();
    if (!idn)  return setFormErr('ת.ז חובה');
    if (!name) return setFormErr('שם מלא חובה');

    setSaving(true);
    try {
      const res = await fetch('/api/admin/create-employee', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          full_name: name,
          id_number: idn,
          phone,
          role: form.role,            // employees.role (display)
          role_code: form.role_code,  // user_roles.role_code (access)
          hired_date: form.hired_date || null,
          active: !!form.active,
          global_worker: !!form.global_worker,
        }),
      });

      // Be robust to HTML error bodies from hosting
      let json: any = null; let text: string | null = null;
      try { json = await res.json(); } catch { text = await res.text(); }
      if (!res.ok || !json?.ok) throw new Error(json?.error || text || 'Create failed');

      const emp = json.employee as EmployeeRow;

      // Prepend and keep sort by full name
      setRows(prev => {
        const next = [emp, ...(prev ?? [])];
        return next.sort((a, b) => (a.full_name ?? '').localeCompare(b.full_name ?? ''));
      });

      // Reset form + close modal
      setOpen(false);
      setForm({
        full_name: '',
        id_number: '',
        phone: '',
        role: 'Assistant Manager',
        role_code: 'assistant_manager',
        hired_date: todayISO(),
        active: true,
        global_worker: false,
      });
    } catch (e: any) {
      setFormErr(e?.message ?? 'שגיאה בהוספת עובד');
    } finally {
      setSaving(false);
    }
  }

  /* ---------- RENDER ---------- */

  if (loadingAccess) {
    return (
      <div dir="rtl" style={{ padding: 24 }}>
        <div className="center-card">טוען הרשאות…</div>
      </div>
    );
  }

  if (!(access === 'ADMIN' || access === 'MANAGER')) {
    return (
      <div dir="rtl" style={{ padding: 24 }}>
        <section className="card" style={{ maxWidth: 920, margin: '40px auto' }}>
          <h2 className="card-title" style={{ marginTop: 0 }}>ניהול צוות</h2>
          <p>אין לך הרשאה לצפות בעמוד זה.</p>
        </section>
      </div>
    );
  }

  return (
    <div dir="rtl" style={{ padding: 24 }}>
      {/* Header */}
      <section className="hero" style={{ textAlign: 'center', marginBottom: 18 }}>
        <h1 className="hero-title" style={{ margin: 0 }}>ניהול צוות</h1>
        <p className="hero-subtitle" style={{ marginTop: 6 }}>
          הוספת עובדים, חיפוש, ומבט כללי על פרטי העובד.
        </p>
      </section>

      {/* Controls + List */}
      <section className="card" style={{ maxWidth: 1100, margin: '0 auto' }}>
        <div style={{ display: 'flex', gap: 8, alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>
          <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
            <button type="button" className="primary-button" onClick={() => setOpen(true)}>
              עובד חדש
            </button>
            <span className="pill small">יוצר גם משתמש כניסה עם סיסמה = טלפון</span>
          </div>
          <input
            placeholder="חפש/י לפי שם / ת.ז / טלפון"
            value={q}
            onChange={(e) => setQ(e.target.value)}
            className="field-input"
            style={{ padding: '8px 10px', borderRadius: 12, border: '1px solid #d9cfbf', minWidth: 260, background: '#f7f2e9' }}
          />
        </div>

        {/* Table */}
        <div style={{ overflowX: 'auto' }}>
          <table style={{ width: '100%', borderCollapse: 'collapse' }}>
            <thead>
              <tr style={{ textAlign: 'right', fontSize: 13, color: '#6b6458' }}>
                <th style={thStyle}>שם מלא</th>
                <th style={thStyle}>ת.ז</th>
                <th style={thStyle}>טלפון</th>
                <th style={thStyle}>תפקיד</th>
                <th style={thStyle}>פעיל</th>
                <th style={thStyle}>גלובלי</th>
                <th style={thStyle}>תאריך תחילה</th>
              </tr>
            </thead>
            <tbody>
              {loading ? (
                <tr><td colSpan={7} style={tdStyle}>טוען…</td></tr>
              ) : err ? (
                <tr><td colSpan={7} style={{ ...tdStyle, color: '#9b2c2c' }}>{err}</td></tr>
              ) : rows && rows.length > 0 ? (
                rows.map((r) => (
                  <tr key={r.id} style={{ borderTop: '1px solid #e5ddcc' }}>
                    <td style={tdStyle}>{r.full_name ?? '—'}</td>
                    <td style={tdStyle}>{r.id_number}</td>
                    <td style={tdStyle}>{r.phone ?? '—'}</td>
                    <td style={tdStyle}>{r.role ?? '—'}</td>
                    <td style={tdStyle}>{boolIcon(r.active)}</td>
                    <td style={tdStyle}>{boolIcon(r.global_worker)}</td>
                    <td style={tdStyle}>{r.hired_date ?? '—'}</td>
                  </tr>
                ))
              ) : (
                <tr><td colSpan={7} style={tdStyle}>לא נמצאו עובדים.</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </section>

      {/* Create modal */}
      {open && (
        <div
          role="dialog"
          aria-modal="true"
          style={{
            position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.25)',
            display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 40,
          }}
          onClick={() => !saving && setOpen(false)}
        >
          <div
            className="card"
            style={{ width: 560, maxWidth: '92vw', padding: 16, background: '#efe6d8' }}
            onClick={(e) => e.stopPropagation()}
          >
            <h3 className="card-title" style={{ marginTop: 0, marginBottom: 8 }}>עובד חדש</h3>
            <form onSubmit={handleCreate}>
              <div style={grid2}>
                <L label="שם מלא">
                  <input
                    required
                    value={form.full_name}
                    onChange={(e) => setForm({ ...form, full_name: e.target.value })}
                    className="field-input" style={inputStyle}
                  />
                </L>

                <L label="ת.ז">
                  <input
                    required
                    value={form.id_number}
                    onChange={(e) => setForm({ ...form, id_number: e.target.value.replace(/\D/g, '') })}
                    className="field-input" style={inputStyle}
                  />
                </L>

                <L label="טלפון (סיסמה דיפולט)">
                  <input
                    value={form.phone}
                    onChange={(e) => setForm({ ...form, phone: e.target.value })}
                    className="field-input" style={inputStyle}
                  />
                </L>

                <L label="תפקיד (תצוגה)">
                  <select
                    value={form.role}
                    onChange={(e) => setForm({ ...form, role: e.target.value })}
                    className="field-input" style={{ ...inputStyle, height: 36 }}
                  >
                    {ROLE_DISPLAY.map((r) => <option key={r} value={r}>{r}</option>)}
                  </select>
                </L>

                <L label="קוד תפקיד (הרשאה)">
                  <select
                    value={form.role_code}
                    onChange={(e) => setForm({ ...form, role_code: e.target.value })}
                    className="field-input" style={{ ...inputStyle, height: 36 }}
                  >
                    {ROLE_CODES.map(r => <option key={r.code} value={r.code}>{r.label}</option>)}
                  </select>
                </L>

                <L label="תאריך תחילה">
                  <input
                    type="date"
                    value={form.hired_date}
                    onChange={(e) => setForm({ ...form, hired_date: e.target.value })}
                    className="field-input" style={inputStyle}
                  />
                </L>

                <L label="פעיל">
                  <input
                    type="checkbox"
                    checked={form.active}
                    onChange={(e) => setForm({ ...form, active: e.target.checked })}
                  />
                </L>

                <L label="גלובלי">
                  <input
                    type="checkbox"
                    checked={form.global_worker}
                    onChange={(e) => setForm({ ...form, global_worker: e.target.checked })}
                  />
                </L>
              </div>

              {formErr && <p style={{ color: '#9b2c2c', fontSize: 12, marginTop: 8 }}>{formErr}</p>}

              <div style={{ display: 'flex', gap: 8, justifyContent: 'flex-start', marginTop: 12 }}>
                <button type="submit" className="primary-button" disabled={saving}>
                  {saving ? 'שומר…' : 'שמירת עובד'}
                </button>
                <button type="button" className="login-btn" onClick={() => setOpen(false)} disabled={saving}>
                  ביטול
                </button>
              </div>
            </form>
            <p className="field-help" style={{ marginTop: 10 }}>
              יוצר משתמש Auth (אימייל: ת.ז@rosterly.local, סיסמה: טלפון) + רשומת עובד + תפקיד.
            </p>
          </div>
        </div>
      )}
    </div>
  );
}

/* UI helpers */
function L({ label, children }: { label: string; children: React.ReactNode }) {
  return (
    <label style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>
      <span className="field-label">{label}</span>
      {children}
    </label>
  );
}
function boolIcon(v: boolean | null | undefined) {
  if (v === true) return '✔︎';
  if (v === false) return '✖︎';
  return '—';
}
const thStyle: React.CSSProperties = { padding: '10px 8px', borderBottom: '1px solid #e5ddcc' };
const tdStyle: React.CSSProperties = { padding: '10px 8px', fontSize: 13, color: '#3a3e2d' };
const grid2: React.CSSProperties = { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10 };
const inputStyle: React.CSSProperties = { padding: '8px 10px', borderRadius: 12, border: '1px solid #d9cfbf', background: '#f7f2e9' };

function useDebounce<T>(value: T, delay: number): T {
  const [debounced, setDebounced] = useState<T>(value);
  useEffect(() => { const id = setTimeout(() => setDebounced(value), delay); return () => clearTimeout(id); }, [value, delay]);
  return debounced;
}
function todayISO() { return new Date().toISOString().slice(0, 10); }
