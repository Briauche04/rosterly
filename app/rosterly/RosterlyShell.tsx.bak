'use client';

import { useEffect, useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { STR, useLang } from "./i18n";
import { supabase } from "@/lib/supabase";

export default function RosterlyShell({ children }: { children: React.ReactNode }) {
  const router = useRouter();
  const searchParams = useSearchParams();
  const lang = useLang(Object.fromEntries(searchParams));
  const t = STR[lang];

  const [email, setEmail] = useState<string | null>(null);

  // Load login state
  useEffect(() => {
    (async () => {
      const { data, error } = await supabase.auth.getUser();
      if (!error && data.user) setEmail(data.user.email ?? null);
      else setEmail(null);
    })();
  }, []);

  const handleLoginClick = () => router.push(`/rosterly/login?lang=${lang}`);
  const handleLogout = async () => {
    await supabase.auth.signOut();
    setEmail(null);
    router.refresh();
  };

  return (
    <div className={t.dir === "rtl" ? "rtl" : ""}>
      {/* ░░ TOP NAV ░░ */}
      <nav className="top-nav">
        {/* Brand */}
        <div
          className="nav-logo"
          style={{ cursor: "pointer" }}
          onClick={() => router.push(`/rosterly?lang=${lang}`)}
        >
          Rosterly
        </div>

        {/* Links */}
        <div className="nav-links">

          {/* Login / Logout */}
          {email ? (
            <>
              <span className="login-btn">{email}</span>
              <button className="logout-btn" onClick={handleLogout}>התנתקות</button>
            </>
          ) : (
            <button className="login-btn" onClick={handleLoginClick}>
              {t.login}
            </button>
          )}

          <a href={`/rosterly/team?lang=${lang}`}>{t.team}</a>
          <a href={`/rosterly/forum?lang=${lang}`}>{t.forum}</a>
          <a href={`/rosterly/tutorials?lang=${lang}`}>{t.tutorials}</a>
        </div>
      </nav>

      {/* ░░ PAGE CONTENT ░░ */}
      <main>{children}</main>

      {/* ░░ FOOTER ░░ */}
      <footer className="landing-footer">
        <small>Privacy • Terms</small>
        <br />
        <small>Rosterly © {new Date().getFullYear()}</small>
      </footer>
    </div>
  );
}
